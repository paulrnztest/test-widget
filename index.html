<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BRAVO â€” Agent Assist (PoC)</title>

  <!-- LivePerson Agent Workspace Widget SDK -->
  <script src="https://lpcdn.lpsnmedia.net/webagent/client-SDK.min.js"></script>

  <style>
    body {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:16px;
    }

    h3 { margin: 0 0 4px 0; }
    h4 { margin-top: 16px; }
    ul { margin: 6px 0 0 18px; }

    button { padding: 6px 10px; cursor:pointer; }

    textarea {
      width:100%;
      box-sizing:border-box;
      resize: vertical;
    }

    .badge {
      background:#e8e8e8;
      padding:3px 6px;
      border-radius:6px;
      font-size:11px;
    }

    .muted {
      color:#666;
      font-size:12px;
    }

    #msgs {
      white-space: pre-wrap;
      border:1px solid #ddd;
      padding:8px;
      background:#fafafa;
      max-height:180px;
      overflow:auto;
      margin-top:6px;
      font-size:13px;
    }

    .assist {
      background:#f7f9fc;
      padding:10px;
      border-left:3px solid #6b8cff;
      margin-top:14px;
    }

    #timestamp {
      margin-left:8px;
    }
  </style>
</head>

<body>

  <h3>BRAVO â€” Agent Assist <span class="badge">preview 1.0.9</span></h3>
  <div class="muted">
    Realâ€‘time guidance based on the current conversation.
    Review before sending â€” youâ€™re always in control.
  </div>

  <div style="margin: 8px 0;">
    Conversation: <b id="convId">(no active conversation)</b>
  </div>

  <div style="margin:10px 0;">
    <button id="btnRefresh">ðŸ”„ Refresh suggestions</button>
    <button id="btnInsert" disabled>Insert suggested reply</button>
    <span id="timestamp" class="muted"></span>
  </div>

  <!-- EMPTY / IDLE STATE -->
  <div id="emptyState" class="assist muted" style="display:none;">
    <b>Waiting for an active conversation</b>
    <div style="margin-top:6px;">
      When you accept a conversation, BRAVO will surface guidance
      and suggested replies here.
    </div>
  </div>

  <!-- ASSIST CONTENT -->
  <div class="assist" id="assistContent">
    <h4>Things to keep in mind</h4>
    <ul>
      <li>
        A higher bill after a recent plan change is often due to a
        <b>transition bill</b>, where customers can see proâ€‘rated charges
        from both the old plan and the new plan on the same bill.
      </li>
      <li>
        A <b>Bill Estimator</b> tool is available internally to help estimate
        charges when customers change broadband plans.
      </li>
    </ul>

    <h4>What to check next</h4>
    <ul>
      <li>
        Check in Spark CRM what plan the customer was on, what plan they moved
        to, and the <b>effective date of the change</b>.
      </li>
      <li>
        Compare the last bill and the current bill to identify
        <b>proâ€‘rated old plan charges / credits</b> and the
        <b>new plan charges</b>.
      </li>
    </ul>

    <h4>Suggested reply <span class="muted">(editable)</span></h4>
    <textarea id="suggestedReply" rows="4" readonly>
Thanks for letting me know youâ€™ve changed plans â€“ thatâ€™s really helpful.
When a plan changes, the first bill afterwards can look higher because it can include part of your old plan, part of your new plan, and any credits or adjustments for the changeover.
Iâ€™ll pull up your last bill and this monthâ€™s bill now and break down exactly whatâ€™s different so you can see whatâ€™s oneâ€‘off for the change and what your regular monthly cost will be going forward.
    </textarea>
  </div>

  <!-- CONVERSATION CONTEXT -->
  <h4>Latest customer messages</h4>
  <div id="msgs"></div>

<script>
/* -------------------------------------------------------
   Agent SDK init
------------------------------------------------------- */
async function waitForAgentSDK(ms = 8000) {
  const t0 = Date.now();
  while (Date.now() - t0 < ms) {
    if (window.lpTag?.agentSDK) return;
    await new Promise(r => setTimeout(r, 100));
  }
  throw new Error("Agent SDK not found in iframe.");
}

let _inited = false;
async function ensureAgentSDK() {
  if (_inited) return;
  await waitForAgentSDK();
  window.lpTag.agentSDK.init({});
  _inited = true;
  console.log("[LP] agentSDK initialised");
}

/* -------------------------------------------------------
   Oneâ€‘shot bind helper
------------------------------------------------------- */
function bindOnce(path) {
  return new Promise((resolve) => {
    const cb = (data) => {
      try { window.lpTag.agentSDK.unbind(path, cb); } catch {}
      resolve(data);
    };
    window.lpTag.agentSDK.bind(path, cb, () => resolve(null));
  });
}

/* -------------------------------------------------------
   Context helpers
------------------------------------------------------- */
async function getConversationIdFromTranscript() {
  const payload = await bindOnce("chatTranscript.lines");
  const lines = payload?.newValue || [];
  const latest = lines.length ? lines[lines.length - 1] : null;
  return latest?.dialogId || "";
}

async function fetchTranscriptSlice(limit = 8) {
  const payload = await bindOnce("chatTranscript.lines");
  const lines = payload?.newValue || [];
  return lines.slice(-limit).map(line => {
    const s = (line.source || line.by || "").toLowerCase();
    return {
      from: s.includes("consumer") ? "consumer" : "agent",
      text: line.text || line.message || ""
    };
  });
}

/* -------------------------------------------------------
   Insert suggested reply (populate composer)
------------------------------------------------------- */
async function insertIntoComposer(text) {
  await ensureAgentSDK();

  const ok = await new Promise(r =>
    window.lpTag.agentSDK.command(
      "setInputText",
      { text },
      () => r(true),
      () => r(false)
    )
  );

  if (!ok) {
    await new Promise(r =>
      window.lpTag.agentSDK.command(
        "Write ChatLine",
        { text },
        () => r(true),
        () => r(false)
      )
    );
  }
}

/* -------------------------------------------------------
   Timestamp helper
------------------------------------------------------- */
function updateTimestamp() {
  const el = document.getElementById("timestamp");
  const now = new Date();
  el.textContent = `Last updated ${now.toLocaleTimeString()}`;
}

/* -------------------------------------------------------
   State + render
------------------------------------------------------- */
const state = { convId: "", messages: [] };
const $ = (sel) => document.querySelector(sel);

function render() {
  const hasConversation = Boolean(state.convId);

  $("#convId").textContent =
    hasConversation ? state.convId : "(no active conversation)";

  $("#emptyState").style.display = hasConversation ? "none" : "block";
  $("#assistContent").style.display = hasConversation ? "block" : "none";

  const msgBox = $("#msgs");
  msgBox.textContent = "";

  if (hasConversation) {
    state.messages
      .filter(m => m.from === "consumer")
      .forEach(m => {
        msgBox.textContent += `ðŸ§‘ ${m.text}\n`;
      });
  }

  $("#btnInsert").disabled =
    !hasConversation || !$("#suggestedReply").value.trim();
}

/* -------------------------------------------------------
   Manual refresh
------------------------------------------------------- */
async function refreshContext() {
  try {
    await ensureAgentSDK();
    state.convId = await getConversationIdFromTranscript();
    state.messages = await fetchTranscriptSlice(8);
    updateTimestamp();
    render();
  } catch (e) {
    console.error("refreshContext failed:", e);
  }
}

/* -------------------------------------------------------
   Autoâ€‘connect once on first conversation
------------------------------------------------------- */
let _autoConnected = false;

async function attachAutoConnectListener() {
  await ensureAgentSDK();

  const handler = (data) => {
    if (_autoConnected) return;

    const lines = data?.newValue || [];
    const latest = lines.length ? lines[lines.length - 1] : null;

    if (latest?.dialogId) {
      _autoConnected = true;
      refreshContext();
      try { window.lpTag.agentSDK.unbind("chatTranscript.lines", handler); } catch {}
    }
  };

  window.lpTag.agentSDK.bind("chatTranscript.lines", handler, () => {});
}

attachAutoConnectListener();

/* -------------------------------------------------------
   Wire up
------------------------------------------------------- */
$("#btnRefresh").addEventListener("click", refreshContext);
$("#btnInsert").addEventListener("click", () =>
  insertIntoComposer($("#suggestedReply").value)
);

// Initial render (idle)
render();
</script>

</body>
</html>




