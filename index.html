<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BRAVO (PoC) — Placeholder Version</title>

  <!-- LivePerson Agent Workspace Widget SDK -->
  <script src="https://lpcdn.lpsnmedia.net/webagent/client-SDK.min.js"></script>

  <style>
    body { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:16px; }
    h3 { margin: 0 0 8px 0; }
    h4 { margin-top: 16px; }
    ul { margin: 6px 0 0 18px; }
    button { padding: 6px 10px; cursor:pointer; }
    textarea { width:100%; box-sizing:border-box; }
    .badge { background:#e8e8e8; padding:3px 6px; border-radius:6px; font-size:11px; }
    #sdkStatus { font-size:12px; margin-bottom:8px; padding:6px; background:#f6f6f6; border-radius:6px; }
    #msgs {
      white-space: pre-wrap;
      border:1px solid #ddd;
      padding:8px;
      background:#fafafa;
      max-height:220px;
      overflow:auto;
      margin-top:6px;
    }
  </style>
</head>

<body>

  <!-- SDK status header -->
  <div id="sdkStatus">Checking LivePerson SDK…</div>

  <h3>BRAVO (PoC) <span class="badge">0.0.8</span></h3>

  <div style="margin: 8px 0;">
    Conversation: <b id="convId">(loading…)</b>
  </div>

  <div style="margin:10px 0;">
    <button id="btnRefresh">Refresh Context</button>
    <button id="btnInsert" disabled>Insert Suggested Reply</button>
  </div>

  <!-- Placeholder Panels (from your earlier version) -->
  <h4>Relevant Information</h4>
  <ul id="relevantInfo">
    <li>A higher bill after a recent plan change is often due to a <b>transition bill</b> where customers can see pro‑rated charges from the old plan and new plan on the same bill.</li>
    <li>A <b>Bill Estimator</b> tool is available internally to help estimate charges when customers change broadband plans.</li>
  </ul>

  <h4>Suggested Next Steps</h4>
  <ul id="nextSteps">
    <li>Check in Spark CRM what plan the customer was on, what plan they moved to, and the <b>effective date of the change.</b></li>
    <li>Compare the last bill and the current bill to identify <b>pro‑rated old plan charges/credits</b> and the <b>new plan charges</b>.</li>
  </ul>

  <h4>Suggested Reply</h4>
  <textarea id="suggestedReply" rows="4" readonly>
Thanks for letting me know you’ve changed plans – that’s really helpful. 
When a plan changes, the first bill afterwards can look higher because it can include part of your old plan, 
part of your new plan, and any credits or adjustments for the changeover. 
I’ll pull up your last bill and this month’s bill now and break down exactly what’s different 
so you can see what’s one‑off for the change and what your regular monthly cost will be going forward.
  </textarea>

  <!-- Latest Messages -->
  <h4>Latest Messages</h4>
  <div id="msgs"></div>

<script>
/* -------------------------------------------------------
   Status indicator
------------------------------------------------------- */
(function () {
  const statusEl = document.getElementById("sdkStatus");
  const mode = () => (window.lpTag?.agentSDK ? "Agent SDK" : "No SDK detected");
  const update = (note) => statusEl.textContent = `[${mode()}] ${note || ""}`.trim();
  update("Waiting for injection…");
  let tries = 0;
  const t = setInterval(() => {
    update("Waiting for injection…");
    if (mode() !== "No SDK detected" || ++tries > 20) clearInterval(t);
  }, 500);
})();

/* -------------------------------------------------------
   Agent SDK initialisation
------------------------------------------------------- */
async function waitForAgentSDK(ms = 8000) {
  const t0 = Date.now();
  while (Date.now() - t0 < ms) {
    if (window.lpTag?.agentSDK) return;
    await new Promise(r => setTimeout(r, 100));
  }
  throw new Error("Agent SDK not found in iframe.");
}

let _inited = false;
async function ensureAgentSDK() {
  if (_inited) return;
  await waitForAgentSDK();
  window.lpTag.agentSDK.init({});
  _inited = true;
  console.log("[LP] agentSDK initialised");
}

/* -------------------------------------------------------
   Helpers (manual refresh path)
   - We bind once just to capture a snapshot then unbind
   - For your tenant, we use chatTranscript.lines + latest.dialogId
   - This mirrors your working debug widget’s approach
------------------------------------------------------- */

// one-shot bind: resolve with first payload then unbind
function bindOnce(path) {
  return new Promise((resolve) => {
    const cb = (data) => {
      try { window.lpTag.agentSDK.unbind(path, cb); } catch {}
      resolve(data);
    };
    window.lpTag.agentSDK.bind(path, cb, () => resolve(null));
  });
}

async function getConversationIdFromTranscript() {
  const payload = await bindOnce("chatTranscript.lines");
  const lines = payload?.newValue || [];
  const latest = Array.isArray(lines) && lines.length ? lines[lines.length - 1] : null;
  return latest?.dialogId || "";  // this is what worked in your debug widget
}

async function fetchTranscriptSlice(limit = 10) {
  const payload =
    (await bindOnce("conversationTranscript.lines")) ||
    (await bindOnce("chatTranscript.lines"));
  const lines = payload?.newValue || [];
  return Array.isArray(lines)
    ? lines.slice(-limit).map(line => {
        const s = (line.source || line.by || "").toLowerCase();
        const from = s.includes("agent") ? "agent" : s.includes("bot") ? "bot" : "customer";
        return { from, text: line.text || line.message || "", dialogId: line.dialogId || "" };
      })
    : [];
}

/* -------------------------------------------------------
   Composer
------------------------------------------------------- */
async function insertIntoComposer(text) {
  await ensureAgentSDK();
  const cmd = (name) => new Promise(r =>
    window.lpTag.agentSDK.command(name, { text }, () => r(true), () => r(false))
  );
  if (await cmd("SendText")) return;
  await cmd("Write ChatLine");
}

/* -------------------------------------------------------
   State + render
------------------------------------------------------- */
const state = { convId: "", messages: [] };
const $ = (sel) => document.querySelector(sel);

function render() {
  $("#convId").textContent = state.convId || "(none)";

  const msgBox = $("#msgs");
  msgBox.textContent = ""; // reset
  state.messages.forEach(m => {
    msgBox.textContent += `${m.from.toUpperCase()}: ${m.text}\n`;
  });

  $("#btnInsert").disabled = !$("#suggestedReply").value.trim();
}

/* -------------------------------------------------------
   Manual refresh flow
------------------------------------------------------- */
async function refreshContext() {
  try {
    await ensureAgentSDK();

    // 1) derive conversationId from transcript (as per your working debug)
    state.convId = await getConversationIdFromTranscript();

    // 2) fetch the latest N lines
    state.messages = await fetchTranscriptSlice(10);

    render();
  } catch (e) {
    console.error("refreshContext failed:", e);
  }
}

/* -------------------------------------------------------
   Wire buttons + initial refresh
------------------------------------------------------- */
$("#btnRefresh").addEventListener("click", refreshContext);
$("#btnInsert").addEventListener("click", () =>
  insertIntoComposer($("#suggestedReply").value)
);

// Initial manual refresh
refreshContext();
</script>

</body>
</html>

