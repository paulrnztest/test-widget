<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LP Debug Widget</title>
  <!-- Agent Workspace Widget SDK -->
  <script src="https://lpcdn.lpsnmedia.net/webagent/client-SDK.min.js"></script>
</head>
<body>
  <h1>LP Debug Widget 1.0.5</h1>
  <p>Open the browser console to see logs.</p>

  <script>
    // Minimal logging
    const log = (...a) => console.log('[LP-DEBUG]', ...a);
    const warn = (...a) => console.warn('[LP-DEBUG]', ...a);
    const err = (...a) => console.error('[LP-DEBUG]', ...a);

    // Wait for lpTag.agentSDK to exist
    function waitForAgentSDK(timeout = 8000) {
      return new Promise((resolve, reject) => {
        const t0 = Date.now();
        (function poll() {
          if (window.lpTag && window.lpTag.agentSDK) return resolve(window.lpTag.agentSDK);
          if (Date.now() - t0 > timeout) return reject(new Error('lpTag.agentSDK not found'));
          setTimeout(poll, 100);
        })();
      });
    }

    (async function main() {
      try {
        const agentSDK = await waitForAgentSDK();
        agentSDK.init({});
        log('agentSDK.init() called');

        // Prefer BIND so we get the value when it becomes available
        const candidates = [
          { path: 'conversationInfo.conversationId', pick: v => v },
          { path: 'conversationInfo',               pick: v => v && (v.conversationId || v.id) },
          { path: 'chatInfo.chatId',                pick: v => v },
          { path: 'conversationData.id',            pick: v => v },
          { path: 'conversationData',               pick: v => v && (v.id || v.conversationId) }
        ];

        let printed = false;

        candidates.forEach(({ path, pick }) => {
          agentSDK.bind(path, (data) => {
            const val = data && data.newValue !== undefined ? data.newValue : data;
            const convId = pick(val);
            if (!printed && convId) {
              printed = true;
              log('Conversation ID:', convId, `(via "${path}")`);
              // Optional: unbind all once we have it
              candidates.forEach(c => { try { agentSDK.unbind(c.path); } catch(e){} });
            }
          }, (e) => { if (e) warn(`bind error on ${path}`, e); });
        });

        // Tiny transcript bind to confirm widget is attached to an active convo
        agentSDK.bind('chatTranscript.lines', (data) => {
          const lines = (data && data.newValue) || [];
          if (lines.length) log('Transcript lines (latest):', lines[lines.length - 1]);
        });

      } catch (e) {
        err('Initialization failed:', e);
      }
    })();
  </script>
</body>
</html>

