<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BRAVO â€” Agent Assist (PoC)</title>

  <!-- LivePerson Agent Workspace Widget SDK -->
  <script src="https://lpcdn.lpsnmedia.net/webagent/client-SDK.min.js"></script>

  <style>
    body {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:16px;
    }

    h3 { margin: 0 0 4px 0; }
    h4 { margin-top: 16px; }
    ul { margin: 6px 0 0 18px; }

    button { padding:6px 10px; cursor:pointer; }
    textarea { width:100%; box-sizing:border-box; resize:vertical; }

    .badge {
      background:#e8e8e8;
      padding:3px 6px;
      border-radius:6px;
      font-size:11px;
    }

    .muted { color:#666; font-size:12px; }

    #msgs {
      white-space: pre-wrap;
      border:1px solid #ddd;
      padding:8px;
      background:#fafafa;
      max-height:180px;
      overflow:auto;
      margin-top:6px;
      font-size:13px;
    }

    .assist {
      background:#f7f9fc;
      padding:10px;
      border-left:3px solid #6b8cff;
      margin-top:14px;
    }

    #timestamp { margin-left:8px; }

    /* References */
    #referencesToggle { cursor:pointer; user-select:none; }
    #referencesList a { text-decoration:none; }
    #referencesList a:hover { text-decoration:underline; }
  </style>
</head>

<body>

<h3>BRAVO â€” Agent Assist <span class="badge">preview 1.0.17</span></h3>
<div class="muted">
  Realâ€‘time guidance based on the current conversation.  
  Review before sending â€” youâ€™re always in control.
</div>

<div style="margin:8px 0;">
  Conversation: <b id="convId">(no active conversation)</b>
</div>

<div style="margin:10px 0;">
  <button id="btnRefresh">ðŸ”„ Refresh suggestions</button>
  <button id="btnInsert" disabled>Insert suggested reply</button>
  <span id="timestamp" class="muted"></span>
</div>

<!-- IDLE / EMPTY STATE -->
<div id="emptyState" class="assist muted" style="display:none;">
  <b>No suggestions yet</b>
  <div style="margin-top:6px;">
    Click <i>Refresh suggestions</i> to load BRAVO guidance for this conversation.
  </div>
</div>

<!-- ASSIST CONTENT -->
<div class="assist" id="assistContent">
  <h4>What to keep in mind</h4>
  <ul id="thingsList"></ul>

  <h4>What to do next</h4>
  <ul id="stepsList"></ul>

  <h4>Suggested reply <span class="muted">(editable)</span></h4>
  <textarea id="suggestedReply"
            rows="4"
            readonly
            placeholder="BRAVO suggestions will appear here."></textarea>

  <!-- References -->
  <div id="referencesSection" class="muted" style="margin-top:10px; display:none;">
    <div id="referencesToggle">â–¶ <span id="referencesCount"></span> reference(s)</div>
    <ul id="referencesList" style="display:none;"></ul>
  </div>
</div>

<h4>Latest customer messages</h4>
<div id="msgs"></div>

<script>
/* ---------- SDK helpers ---------- */
async function waitForAgentSDK(ms=8000){
  const t=Date.now();
  while(Date.now()-t<ms){
    if(window.lpTag?.agentSDK) return;
    await new Promise(r=>setTimeout(r,100));
  }
  throw new Error("Agent SDK not available");
}

let sdkInit=false;
async function ensureSDK(){
  if(sdkInit) return;
  await waitForAgentSDK();
  lpTag.agentSDK.init({});
  sdkInit=true;
}

/* ---------- Bind helper ---------- */
function bindOnce(path){
  return new Promise(resolve=>{
    const cb=d=>{
      try{lpTag.agentSDK.unbind(path,cb);}catch{}
      resolve(d);
    };
    lpTag.agentSDK.bind(path,cb,()=>resolve(null));
  });
}

/* ---------- Context ---------- */
async function getConversationId(){
  const p=await bindOnce("chatTranscript.lines");
  const l=p?.newValue||[];
  return l.length?l[l.length-1].dialogId:"";
}

async function getCustomerMessages(limit=12){
  const p=await bindOnce("chatTranscript.lines");
  const l=p?.newValue||[];
  return l.slice(-limit).map(x=>{
    const s=(x.source||x.by||"").toLowerCase();
    if(s.includes("consumer")||s.includes("visitor")||s.includes("customer")){
      return x.text||x.message||"";
    }
    return null;
  }).filter(Boolean);
}

/* ---------- Fake BRAVO ---------- */
async function fetchFakeBravo(){
  const r=await fetch("./fake-bravo/default.json",{cache:"no-store"});
  if(!r.ok) throw new Error("Fake BRAVO unavailable");
  return r.json();
}

/* ---------- Insert ---------- */
async function insertReply(text){
  if(!text) return;
  await ensureSDK();
  const sdk=lpTag.agentSDK;
  const c=sdk.cmdNames||{};
  const p={text:text.trim()};
  const tryCmd=n=>new Promise(res=>sdk.command(n,p,()=>res(true),()=>res(false)));
  if(c.write && await tryCmd(c.write)) return;
  if(c.writeSC && await tryCmd(c.writeSC)) return;
}

/* ---------- References ---------- */
function renderReferences(refs){
  const sec=$("#referencesSection"),tgl=$("#referencesToggle"),
        cnt=$("#referencesCount"),list=$("#referencesList");
  if(!Array.isArray(refs)||!refs.length){
    sec.style.display="none";
    return;
  }
  cnt.textContent=refs.length;
  list.innerHTML=refs.map(r=>`<li>${a(r.url)}${e(r.title||r.url)}</a></li>`).join("");
  sec.style.display="block";
  list.style.display="none";
  tgl.innerHTML=`â–¶ ${refs.length} reference(s)`;
  tgl.onclick=()=>{
    const open=list.style.display==="block";
    list.style.display=open?"none":"block";
    tgl.innerHTML=`${open?"â–¶":"â–¼"} ${refs.length} reference(s)`;
  };
}

/* ---------- Rendering ---------- */
const state={convId:"",messages:[],bravo:null};

const $=s=>document.querySelector(s);
const e=s=>String(s).replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[m]));
const a=u=>`<a href="${e(u)}" target="_blank">`;

function clearUI(){
  $("#thingsList").innerHTML=`<li class="muted">No guidance available.</li>`;
  $("#stepsList").innerHTML="";
  $("#suggestedReply").value="";
  renderReferences([]);
}

function render(){
  const connected=!!state.convId;
  $("#convId").textContent=connected?state.convId:"(no active conversation)";
  $("#emptyState").style.display=connected && !state.bravo ? "block" : "none";
  $("#assistContent").style.display=connected ? "block" : "none";

  $("#msgs").textContent=state.messages.map(m=>`ðŸ§‘ ${m}`).join("\n");

  if(connected && state.bravo){
    const b=state.bravo;
    $("#thingsList").innerHTML=(b.relevantInfo||[]).map(x=>`<li>${e(x)}</li>`).join("");
    $("#stepsList").innerHTML=(b.nextSteps||[]).map(x=>`<li>${e(x)}</li>`).join("");
    $("#suggestedReply").value=b.suggestedReply||"";
    renderReferences(b.references||[]);
  } else if (connected) {
    clearUI();
  }

  $("#btnInsert").disabled=!connected||!$("#suggestedReply").value;
}

/* ---------- Refresh ---------- */
async function refresh(){
  try{
    await ensureSDK();
    state.convId=await getConversationId();
    state.messages=await getCustomerMessages();
    if(state.convId){
      try{ state.bravo=await fetchFakeBravo(); }
      catch{ state.bravo=null; }
    }else{
      state.bravo=null;
    }
    $("#timestamp").textContent=`Last updated ${new Date().toLocaleTimeString()}`;
    render();
  }catch(e){console.error(e);}
}

/* ---------- Auto-connect once ---------- */
let connectedOnce=false;
async function autoConnect(){
  await ensureSDK();
  lpTag.agentSDK.bind("chatTranscript.lines",async d=>{
    if(connectedOnce) return;
    const l=d?.newValue||[];
    if(l.length && reminds(l[l.length-1]?.dialogId)){
      connectedOnce=true;
      await refresh();
    }
  });
}

function reminds(x){return!!x;}

$("#btnRefresh").onclick=refresh;
$("#btnInsert").onclick=()=>insertReply($("#suggestedReply").value);

render();
autoConnect();
</script>

</body>
</html>

